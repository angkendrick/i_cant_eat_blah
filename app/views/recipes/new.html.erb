<h1>Recipes/New</h1>

<% if @recipe.errors.any? %>
    <div>
      <%= pluralize(@recipe.errors.count, 'error') %> prevented the recipe from being created:
      <ul>
        <% @recipe.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
<% end %>

<form id="newRecipe">
  Recipe Name<input type="text" id="recipe_name" name="recipe_name"><br>
  <div id="sandbox"></div>
  <div id="selectHolder"></div>
  <input type="submit" value="submit">
</form>

<button id="addStage">Add a Stage</button>

<script>

  $(function(){

      var ingredients = <%= raw @ingredients.to_json %>
      var measurements = <%= raw @measurements.to_json %>
      var stageCount = 1;
      var count = 1;

      $("#addStage").on("click", function(){
          $("#sandbox").append("<div id='stage" + stageCount + "' data-count='1'>Instructions<input type='text' name ='stage" + stageCount + "'><br>" +
                  "<button type='button' class='dynamicIngredients'>Add more ingredients</button></div>"); //add instructions field
          stageCount++;

      });

      $("#sandbox").on("click", "button.dynamicIngredients", function(){
          var origin = $(this).parent();
          addIngredients(origin);
          var dataCount = origin.data("count");
          dataCount++;
          origin.data("count", dataCount);

      });

//      $("#addIngredients").on("click", function(){
//          addIngredients();
//      });

      function addIngredients(origin){
          var id = origin.attr('id');
          var dataCount = origin.data("count");
          $(origin).append("<select id='" + id + "_ingredients" + dataCount + "' name='" + id + "_ingredients" + dataCount + "'></select>"); //add ingredients select
          $.each(ingredients, function(i, ingredient){
              $("#" + id + "_ingredients" + dataCount + "").append("<option value='" + ingredient.id + "'>" + ingredient.name + "</option>");
          });

          $(origin).append("<input type='number' name='" + id + "_quantity" + dataCount + "'>");

          $(origin).append("<select id='" + id + "_measurements" + dataCount + "' name='" + id + "_measurements" + dataCount + "'></select><br>"); //add measurements select
          $.each(measurements, function(i, measurement){
              $("#" + id + "_measurements" + dataCount + "").append("<option value='" + measurement.id + "'>" + measurement.short_name + "</option>");
          });

          count++;
      }

      $("#newRecipe").submit(function(event){
          event.preventDefault();
          var formData = $("#newRecipe").serializeArray();


          $.ajax({
              type  : 'POST',
              url   : '<%= recipes_path %>',
              data  : formData
          })
          .done(function(data){
            console.log('looking good!');
            console.log(data);
          })
          .error(function(data){
            console.log('something went wrong!');
            console.log(data);
          });

      });


      console.log('ready!');
  });

</script>